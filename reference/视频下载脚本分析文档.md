# 短视频批量下载脚本分析文档

## 概述

这是一个功能强大的Tampermonkey用户脚本，支持多个主流短视频平台的视频批量下载，包括抖音、快手、微视、Instagram、TikTok、小红书、微博、今日头条等。

## 基本信息

- **脚本名称**: 抖音/快手/微视/instagram/TIKTOK/小红书/微博/今日头条 主页视频下载
- **版本**: 1.4.0
- **作者**: hunmer
- **运行时机**: document-start
- **许可证**: MIT

## 核心架构

### 1. 全局配置与工具函数

#### 常量定义
```javascript
const ERROR = -1, WAITTING = 0, DOWNLOADING = 1, DOWNLOADED = 2
const VERSION = '1.4.9', RELEASE_DATE = '2025/06/11'
```

#### 工具函数
- `guid()`: 生成唯一标识符
- `Date.prototype.format()`: 日期格式化扩展
- `flattenArray()`: 数组扁平化
- `cutString()`: 字符串截取
- `escapeHTMLPolicy`: HTML安全策略处理

### 2. 主要功能模块

#### 核心下载器对象 `_downloader`

**配置选项** (`options`)
- `threads`: 下载线程数 (默认8)
- `autoRename`: 自动重命名
- `alert_done`: 下载完成提示
- `timeout`: 超时时间 (默认60秒)
- `aria2c_*`: Aria2下载工具配置

**核心方法**
- `addDownload()`: 添加下载任务
- `removeDownload()`: 移除下载任务
- `switchRunning()`: 切换运行状态
- `showList()`: 显示主界面

#### 平台支持系统

脚本通过 `HOSTS` 对象定义各平台的解析规则：

```javascript
this.HOSTS = {
    'www.douyin.com': { // 抖音
        title: '抖音',
        id: 'douyin',
        rules: [/* 解析规则 */]
    },
    'www.xiaohongshu.com': { // 小红书
        title: '小红书',
        id: 'xhs',
        getVideoURL: item => Promise /* 获取真实下载链接 */
    }
    // ... 其他平台
}
```

### 3. 数据获取机制

#### 网络请求拦截
脚本通过Hook以下API来拦截网络请求：
- `XMLHttpRequest.prototype.send`
- `window.fetch`
- `Response.prototype.json`
- `JSON.parse`

#### 数据解析流程
1. **规则匹配**: 根据URL模式匹配对应的解析规则
2. **数据提取**: 从响应中提取视频列表数据
3. **信息解析**: 解析单个视频的元信息（标题、作者、链接等）
4. **状态管理**: 维护下载状态（等待、下载中、已完成、错误）

### 4. 用户界面

#### 主界面组件
- **控制面板**: 全选/反选、清空日志、设置等
- **命名规则**: 支持变量替换（{发布者}、{标题}、{id}、{i}）
- **下载配置**: 线程数、Aria2开关
- **数据表格**: 显示视频列表和下载状态
- **日志面板**: 实时显示下载日志

#### 对话框系统
使用 `showDialog()` 方法创建模态对话框：
- 设置对话框
- 重命名帮助对话框
- 数据导入/导出对话框

### 5. 下载机制

#### 下载方式
1. **GM_download**: 使用Tampermonkey内置下载API
2. **Aria2**: 支持外部Aria2下载工具
3. **StreamSaver**: 流式下载（大文件）
4. **FileSaver**: 浏览器文件保存

#### 下载流程
1. **任务排队**: 将选中的视频添加到下载队列
2. **并发控制**: 根据线程数控制同时下载数量
3. **重试机制**: 下载失败时自动重试
4. **状态更新**: 实时更新界面状态和日志

### 6. 平台特性处理

#### 小红书 (xiaohongshu.com)
- 支持图片和视频内容
- 需要二次请求获取真实下载链接
- 解析noteDetailMap获取详细信息

#### 抖音 (douyin.com)
- 支持多个下载线路
- 处理个人主页、搜索页、单视频页
- 解析aweme_list获取视频列表

#### TikTok (tiktok.com)
- 国际版抖音支持
- 处理bitrateInfo获取最佳画质
- 特殊的Referer处理

#### Instagram (instagram.com)
- 支持Reels视频下载
- GraphQL API数据解析
- 媒体类型检测

### 7. 自动化功能

#### 自动滚动捕获
- `switchAutoScroll()`: 自动滚动页面捕获更多视频
- 智能检测新增内容
- 支持自动下载模式

#### 批量重命名
- 支持变量替换系统
- 日期时间格式化
- 文件名安全字符处理

### 8. 数据管理

#### 导入/导出功能
- **导出数据**: JSON格式导出完整数据
- **导出链接**: 纯文本格式导出下载链接
- **导入数据**: 支持从JSON文件恢复数据

#### 存储机制
- 使用 `GM_setValue/GM_getValue` 持久化配置
- 运行时数据存储在 `resources` 数组中

## 技术要点

### 1. 安全处理
- 使用 `trustedTypes` 防止XSS攻击
- HTML内容通过 `createHTML()` 安全处理
- 文件名安全字符转换

### 2. 兼容性处理
- 检测浏览器API支持情况
- 多种下载方案fallback
- Safari浏览器特殊处理

### 3. 性能优化
- 图片预览数量限制
- 流式下载支持
- 并发控制机制

### 4. 错误处理
- 网络请求重试机制
- 详细的错误日志记录
- 用户友好的错误提示

## 总结

这是一个架构完整、功能丰富的短视频下载工具。脚本采用模块化设计，支持多平台、多下载方式，具备完善的用户界面和自动化功能。通过网络请求拦截和数据解析，实现了对各大短视频平台的批量下载支持。

主要优势：
- **多平台支持**: 覆盖主流短视频平台
- **灵活配置**: 丰富的配置选项和个性化设置
- **用户友好**: 直观的界面和详细的使用帮助
- **技术先进**: 使用现代浏览器API和最佳实践
- **可扩展性**: 模块化架构便于添加新平台支持

适合用作短视频下载工具的参考实现，也可作为Tampermonkey脚本开发的学习案例。